[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-31 22:00:19.195704",
  "module": "Tatweer Custom Fields",
  "name": "task wight100",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Task",
  "script": "if doc.project and not doc.parent_task:  # Ensure the task is linked to a project\n    total_weight = 0\n    total_weight_of_project_cost = 0 \n    \n    # Get all tasks related to the same project\n    # Exclude the current document if it's an existing one (to avoid double counting its current weight)\n    # and then add its new weight.\n    # If it's a new document, it won't have a name yet, so it will be included directly.\n    \n    # Fetch weights of existing tasks in the project\n    existing_tasks = frappe.db.get_all(\n        \"Task\",\n        filters={\n            \"project\": doc.project,\n            \"docstatus\": 0,  # Only consider active tasks (not cancelled or submitted)\n            \"name\": (\"!=\", doc.name) if doc.name else None,\n            \"parent_task\": [\"is\", \"not set\"]\n        },\n        fields=[\"custom__weight_of_technical_achievement\" , \"custom_weight_of_project_cost\"]\n    )\n    \n    for task in existing_tasks:\n        if task.custom__weight_of_technical_achievement:\n            total_weight = total_weight + float(task.custom__weight_of_technical_achievement)\n    \n        if task.custom_weight_of_project_cost:\n            total_weight_of_project_cost = total_weight_of_project_cost + float(task.custom_weight_of_project_cost)\n\n    # Add the weight of the current task being saved\n    if doc.custom__weight_of_technical_achievement:\n        total_weight = total_weight + float(doc.custom__weight_of_technical_achievement)\n        \n    if doc.custom_weight_of_project_cost:\n        total_weight_of_project_cost = total_weight_of_project_cost + float(doc.custom_weight_of_project_cost)\n\n    # Check if the total weight exceeds 100%\n    if total_weight > 100:\n        frappe.throw(\n            f\"Total task weight for project '{doc.project}' cannot exceed 100%. \"\n            f\"Current total: {total_weight}%.\"\n        )\n\n    # Check if the total weight exceeds 100%\n    if total_weight_of_project_cost > 100:\n        frappe.throw(\n            f\"Total task cost weight for project '{doc.project}' cannot exceed 100%. \"\n            f\"Current total: {total_weight_of_project_cost}%.\"\n        )        \n\n\nif doc.parent_task:  # Ensure the task is linked to a project\n    total_sub_weight = 0\n    total_sub_weight_of_project_cost = 0 \n\n    # Fetch weights of existing tasks in the project\n    existing_tasks = frappe.db.get_all(\n        \"Task\",\n        filters={\n            \"parent_task\": doc.parent_task,\n            \"docstatus\": 0,  # Only consider active tasks (not cancelled or submitted)\n            \"name\": (\"!=\", doc.name) if doc.name else None,\n        },\n        fields=[\"custom__weight_of_technical_achievement\" , \"custom_weight_of_project_cost\"]\n    )\n    \n    for task in existing_tasks:\n        if task.custom__weight_of_technical_achievement:\n            total_sub_weight = total_sub_weight + float(task.custom__weight_of_technical_achievement)\n        if task.custom_weight_of_project_cost:\n            total_sub_weight_of_project_cost = total_sub_weight_of_project_cost + float(task.custom_weight_of_project_cost)\n\n    # Add the weight of the current task being saved\n    if doc.custom__weight_of_technical_achievement:\n        total_sub_weight = total_sub_weight + float(doc.custom__weight_of_technical_achievement)\n    \n    \n            \n    if doc.custom_weight_of_project_cost:\n        total_sub_weight_of_project_cost = total_sub_weight_of_project_cost + float(doc.custom_weight_of_project_cost)\n\n    # Check if the total weight exceeds 100%\n    if total_sub_weight > 100:\n        frappe.throw(\n            f\"Total sub task weight for task '{doc.parent_task}' cannot exceed 100%. \"\n            f\"Current total: {total_sub_weight}%.\"\n        )\n\n    # Check if the total weight exceeds 100%\n    if total_sub_weight_of_project_cost > 100:\n        frappe.throw(\n            f\"Total task cost weight for project '{doc.project}' cannot exceed 100%. \"\n            f\"Current total: {total_sub_weight_of_project_cost}%.\"\n        )        \n",
  "script_type": "DocType Event"
 }
]